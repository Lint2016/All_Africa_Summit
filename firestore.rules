rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if a user is an admin
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.admin == true;
    }

    // Rate limiting function - allows 3 submissions per IP per hour
    function isRateLimited(ip) {
      let ipDoc = get(/databases/$(database)/documents/rateLimits/$(ip));
      let now = request.time;
      let windowStart = now - duration.value(1, 'h');
      
      if (!ipDoc.exists) {
        // First submission from this IP
        setData({
          'count': 1,
          'lastAttempt': now
        });
        return false;
      }
      
      let count = ipDoc.data.count;
      let lastAttempt = ipDoc.data.lastAttempt;
      
      // Reset counter if last attempt was outside the rate limit window
      if (lastAttempt < windowStart) {
        setData({
          'count': 1,
          'lastAttempt': now
        });
        return false;
      }
      
      // Check if rate limit exceeded
      if (count >= 3) {
        return true;
      }
      
      // Update counter and timestamp
      setData({
        'count': count + 1,
        'lastAttempt': now
      });
      
      return false;
    }
    
    // Helper function to update rate limiting
    function setData(data) {
      set(/databases/$(database)/documents/rateLimits/$(request.resource.data.ipAddress), data);
    }

    // Registrations collection
    match /registrations/{document=**} {
      // Allow read for admins only
      allow read: if isAdmin();
      
      // Allow create with rate limiting
      allow create: if !isRateLimited(request.resource.data.ipAddress) 
                   && request.resource.data.firstName is string
                   && request.resource.data.lastName is string
                   && request.resource.data.email.matches('^[^@]+@[^@]+\\.+[^@]+$')
                   && request.resource.data.phone is string
                   && request.resource.data.emergencyPhone is string
                   && request.resource.data.country is string
                   && request.resource.data.dietary is string
                   && request.resource.data.eftReference is string
                   && request.resource.data.paymentMethod is string
                   && request.resource.data.status is string
                   && request.resource.data.submissionTime is string
                   && request.resource.data.attemptCount is number
                   && request.resource.data.lastAttempt is timestamp;
    }
    
    // Rate limits collection - only for internal use
    match /rateLimits/{ip} {
      allow read: if isAdmin();
      allow write: if false; // Only written by rules
    }
  }
}
